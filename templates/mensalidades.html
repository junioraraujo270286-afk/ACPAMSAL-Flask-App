{% extends "base.html" %}
{% block title %}Gerenciar Mensalidades{% endblock %}
{% block content %}
<h2 class="text-secondary">ðŸ’° Gerenciar Mensalidades</h2>
<p class="text-muted">Controle de pagamentos dos associados. Mensalidade base: **R$ {{ "{:,.2f}".format(mensalidade_base) }}**</p>
<hr>

<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        <thead>
            <tr>
                <th>MatrÃ­cula</th>
                <th>Nome</th>
                <th>Status</th>
                <th>DÃ©bito (Meses)</th>
                <th>DÃ­vida Total</th>
                <th>AÃ§Ãµes</th>
            </tr>
        </thead>
        <tbody>
            {% for assoc in associados %}
            <tr>
                <td>{{ assoc.matricula }}</td>
                <td>{{ assoc.nome }}</td>
                <td>
                    <span class="badge bg-{{ 'success' if 'Em Dia' in assoc.status else 'danger' if 'Desligado' in assoc.status else 'warning' }}">
                        {{ assoc.status }}
                    </span>
                </td>
                <td>
                    <span class="badge bg-{{ 'danger' if assoc.total_devido > 0 else 'success' }}">
                        {{ assoc.total_devido }}
                    </span>
                </td>
                <td>{{ assoc.divida }}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#modalPagamento{{ assoc.id }}">
                        Gerenciar
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% for assoc in associados %}
<div class="modal fade" id="modalPagamento{{ assoc.id }}" tabindex="-1" aria-labelledby="modalPagamentoLabel{{ assoc.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalPagamentoLabel{{ assoc.id }}">Gerenciar Pagamentos: {{ assoc.nome }} (Mat.: {{ assoc.matricula }})</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>DÃ­vida Total:</strong> <span class="text-danger">{{ assoc.divida }}</span> ({{ assoc.total_devido }} meses)</p>
                <hr>
                
                <h6 class="text-primary">Meses Pendentes</h6>
                <div class="mb-3">
                    {% if assoc.meses_devidos %}
                        {% for mes_devido in assoc.meses_devidos %}
                            <form action="{{ url_for('gerenciar_mensalidades_web') }}" method="POST" style="display:inline; margin-right: 10px;">
                                <input type="hidden" name="associado_id" value="{{ assoc.id }}">
                                <input type="hidden" name="mes_ano" value="{{ mes_devido }}">
                                <input type="hidden" name="acao" value="registrar">
                                <button type="submit" class="btn btn-sm btn-outline-danger mb-2" title="Registrar pagamento de {{ mes_devido }}">
                                    PAGAR: {{ mes_devido }} (R$ {{ "{:,.2f}".format(mensalidade_base) }})
                                </button>
                            </form>
                        {% endfor %}
                    {% else %}
                        <p class="text-success">Nenhum dÃ©bito pendente!</p>
                    {% endif %}
                </div>

                <hr>

                <h6 class="text-primary">Registrar ou Remover Pagamento (Manual)</h6>
                <form action="{{ url_for('gerenciar_mensalidades_web') }}" method="POST" class="row g-3">
                    <input type="hidden" name="associado_id" value="{{ assoc.id }}">
                    
                    <div class="col-md-5">
                        <label for="mesAno{{ assoc.id }}" class="form-label">MÃªs/Ano de ReferÃªncia</label>
                        <select class="form-select" id="mesAno{{ assoc.id }}" name="mes_ano" required>
                            <option value="">Selecione o MÃªs</option>
                            {% for mes in meses_disponiveis %}
                            <option value="{{ mes }}">{{ mes }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">AÃ§Ã£o</label>
                        <select class="form-select" name="acao" required>
                            <option value="registrar">Registrar Pagamento</option>
                            <option value="remover">Remover Pagamento</option>
                        </select>
                    </div>

                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Executar AÃ§Ã£o</button>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>
{% endfor %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}
